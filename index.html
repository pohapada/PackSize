<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4a6fa5">
    <meta name="description" content="Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø¨Ø¹Ø§Ø¯ Ú©Ø§Ø±ØªÙ† - Ù‚Ø§Ø¨Ù„ Ù†ØµØ¨">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Ú©Ø§Ø±ØªÙ† Ù…Ø­Ø§Ø³Ø¨Ù‡">
    <title>Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø¨Ø¹Ø§Ø¯ Ú©Ø§Ø±ØªÙ† â€” Ù†Ø³Ø®Ù‡ Ø§Ø±ØªÙ‚Ø§ ÛŒØ§ÙØªÙ‡</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">

    <style>
        /* ---------- Variables ---------- */
        :root{
            --bg: #f4f7fb;
            --card: #ffffff;
            --muted: #6b7280;
            --primary: #336699; /* main */
            --primary-2: #4a6fa5; /* accent */
            --accent: #ff7e5f;
            --glass: rgba(255,255,255,0.65);
            --shadow: 0 8px 24px rgba(28,40,60,0.08);
            --radius: 12px;
            --radius-sm: 8px;
            --success: #2ecc71;
            --danger: #e74c3c;
            --mono: 'Courier New', monospace;
        }

        /* ---------- Base ---------- */
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #eef4fb 0%, var(--bg) 100%);
            color:#12202b;
            padding:20px;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        .container{max-width:1100px;margin:0 auto}

        /* ---------- Header ---------- */
        header.app-header{
            display:flex;align-items:center;gap:18px;
            background: linear-gradient(135deg,var(--card),#f7fbff);
            padding:18px;border-radius:16px;box-shadow:var(--shadow);
            margin-bottom:20px;position:relative;overflow:hidden;
        }

        .brand{
            display:flex;align-items:center;gap:12px
        }

        .logo{
            width:72px;height:72px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:34px;color:white;background:linear-gradient(135deg,var(--primary),var(--primary-2));box-shadow:0 6px 18px rgba(74,111,165,0.18)
        }

        .title-wrap h1{margin:0;font-size:20px;letter-spacing:0.2px}
        .title-wrap p{margin:0;color:var(--muted);font-size:13px}

        /* top-right controls */
        .top-actions{margin-left:auto;display:flex;align-items:center;gap:10px}
        .icon-btn{background:transparent;border:0;padding:8px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
        .icon-btn:focus{outline:2px solid rgba(51,102,153,0.18)}

        .install-btn{display:flex;align-items:center;gap:8px;background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:0;font-weight:600}

        /* ---------- Layout ---------- */
        main.grid{
            display:grid;grid-template-columns: 1fr 420px;gap:20px;align-items:start
        }
        @media(max-width:980px){main.grid{grid-template-columns:1fr} .top-actions{margin-top:10px}}

        /* ---------- Card ---------- */
        .card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}

        /* ---------- Input area ---------- */
        .inputs{display:flex;flex-direction:column;gap:12px}
        label{font-weight:700;font-size:13px;color:#233444;margin-bottom:6px}
        .row{display:flex;gap:12px}
        .row .field{flex:1}
        input[type=number]{width:100%;padding:12px;border-radius:10px;border:1px solid #e6eef8;font-size:15px}
        input[type=number]:focus{box-shadow:0 4px 14px rgba(74,111,165,0.06);border-color:var(--primary-2);outline:none}

        .calculate-wrap{display:flex;gap:12px;margin-top:12px}
        .btn{padding:12px 16px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
        .btn-primary{background:linear-gradient(90deg,var(--primary),var(--primary-2));color:#fff}
        .btn-ghost{background:transparent;border:1px solid #e6eef8;color:var(--primary-2)}

        /* ---------- Results ---------- */
        .results{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
        .result-card{padding:14px;border-radius:12px;border:1px solid #eef6ff;background:linear-gradient(180deg,rgba(255,255,255,0.9),var(--glass));}
        .result-card h3{margin:0 0 8px 0;color:var(--primary-2)}
        .dim{display:flex;justify-content:space-between;align-items:center;padding:6px 0}
        .dim .v{font-weight:700}
        .copy-btn{background:transparent;border:0;cursor:pointer;padding:6px;border-radius:8px}

        /* ---------- Settings modal/drawer ---------- */
        .overlay{position:fixed;inset:0;background:rgba(8,12,20,0.35);display:none;align-items:flex-end;justify-content:center;padding:18px;z-index:60}
        .overlay.show{display:flex}
        .drawer{width:100%;max-width:760px;background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);transform:translateY(36px);opacity:0;transition:all .22s ease}
        .overlay.show .drawer{transform:translateY(0);opacity:1}

        .settings-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
        .settings-header h2{margin:0}

        .formula-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        @media(max-width:720px){.formula-grid{grid-template-columns:1fr}}

        textarea.formula{width:100%;min-height:56px;border-radius:10px;border:1px solid #e6eef8;padding:10px;font-family:var(--mono);font-size:13px}

        .settings-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

        /* ---------- small helpers ---------- */
        .muted{color:var(--muted);font-size:13px}
        .tag{background:#f0f8ff;padding:6px 8px;border-radius:8px;font-weight:700}

        /* notification */
        .toast{position:fixed;left:20px;bottom:20px;background:var(--primary-2);color:#fff;padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);display:none;z-index:80}
        .toast.show{display:block}

        /* accessible focus */
        button:focus, input:focus, textarea:focus{outline:2px solid rgba(74,111,165,0.12)}

        /* small responsive tweaks */
        @media (max-width:420px){.logo{width:56px;height:56px;font-size:28px}.title-wrap h1{font-size:16px}}
    </style>
</head>
<body>
    <div class="container">
        <header class="app-header">
            <div class="brand">
                <div class="logo" aria-hidden="true">ğŸ“¦</div>
                <div class="title-wrap">
                    <h1>Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø¨Ø¹Ø§Ø¯ Ú©Ø§Ø±ØªÙ†</h1>
                    <p>Ø³Ø±ÛŒØ¹ â€” Ø¯Ù‚ÛŒÙ‚ â€” Ù‚Ø§Ø¨Ù„ Ù†ØµØ¨ (PWA)</p>
                </div>
            </div>

            <div class="top-actions">
                <button id="installButton" class="install-btn" aria-hidden="true">Ù†ØµØ¨ Ø¨Ø±Ù†Ø§Ù…Ù‡ â¤“</button>

                <!-- gear icon opens settings drawer -->
                <button id="openSettings" class="icon-btn" title="ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ (G)" aria-label="ØªÙ†Ø¸ÛŒÙ…Ø§Øª">
                    <!-- gear SVG -->
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                        <path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z"></path>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 0 1 2.3 16.9l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09c.7 0 1.29-.44 1.51-1a1.65 1.65 0 0 0-.33-1.82L4.3 4.3A2 2 0 0 1 7.13 1.47l.06.06c.5.5 1.2.72 1.82.33.5-.32 1.1-.5 1.7-.5h.06A2 2 0 0 1 12 1a2 2 0 0 1 .92.28c.6.12 1.3.5 1.7.82l.06.06A2 2 0 0 1 19.7 4.3l-.06.06c-.5.5-.72 1.2-.33 1.82.32.5.5 1.1.5 1.7V9c0 .07 0 .14.01.21.02.43.2.84.5 1.2.39.5.72 1.1.72 1.72z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <main class="grid">
            <section class="card">
                <div class="inputs">
                    <div class="row">
                        <div class="field">
                            <label for="length">Ø·ÙˆÙ„ (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±)</label>
                            <input id="length" type="number" min="0" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 25.5">
                        </div>
                        <div class="field">
                            <label for="width">Ø¹Ø±Ø¶ (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±)</label>
                            <input id="width" type="number" min="0" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 18">
                        </div>
                    </div>

                    <div class="row">
                        <div class="field">
                            <label for="height">Ø§Ø±ØªÙØ§Ø¹ (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±)</label>
                            <input id="height" type="number" min="0" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 12">
                        </div>
                        <div style="width:140px;display:flex;flex-direction:column;justify-content:flex-end;">
                            <div class="muted" style="font-size:12px;margin-bottom:6px">Ø¹Ù…Ù„ÛŒØ§Øª Ø³Ø±ÛŒØ¹</div>
                            <div style="display:flex;gap:8px">
                                <button id="calcNow" class="btn btn-primary">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
                                <button id="clearBtn" class="btn btn-ghost">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
                            </div>
                        </div>
                    </div>

                    <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
                        <div class="tag">Û´ ÙØ±Ù…ÙˆÙ„ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ¾Ø°ÛŒØ±</div>
                        <div class="muted">ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
                    </div>

                    <div style="margin-top:14px">
                        <label class="muted">Ø®Ø±ÙˆØ¬ÛŒ Ø³Ø±ÛŒØ¹</label>
                        <div id="quickSummary" class="card" style="margin-top:8px;padding:12px;background:#fbfdff;border-radius:10px;border:1px solid #eef6ff;">
                            <div class="muted">Ù†ØªØ§ÛŒØ¬ Ù¾Ø³ Ø§Ø² Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Â«Ù…Ø­Ø§Ø³Ø¨Ù‡Â» Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
                        </div>
                    </div>
                </div>
            </section>

            <aside class="card">
                <h3 style="margin-top:0">Ù†ØªØ§ÛŒØ¬ Ù…Ø­Ø§Ø³Ø¨Ø§Øª</h3>
                <div id="resultsGrid" class="results">
                    <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù†ØªÛŒØ¬Ù‡ Ø§ÛŒÙ†Ø¬Ø§ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                </div>

                <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
                    <button id="copyAll" class="btn btn-ghost">Ú©Ù¾ÛŒ Ù‡Ù…Ù‡</button>
                    <button id="exportCsv" class="btn btn-ghost">Ø®Ø±ÙˆØ¬ÛŒ CSV</button>
                </div>
            </aside>

            <!-- settings drawer (overlay) -->
            <div id="overlay" class="overlay" role="dialog" aria-hidden="true">
                <div class="drawer" role="document">
                    <div class="settings-header">
                        <h2>Ù…Ù†ÙˆÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§</h2>
                        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
                            <button id="closeSettings" class="icon-btn" title="Ø¨Ø³ØªÙ†">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M18 6L6 18M6 6l12 12"/></svg>
                            </button>
                        </div>
                    </div>

                    <div class="muted" style="margin-bottom:8px">Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ØŒ ØªØ³Øª Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯. ØªÙ…Ø§Ù… ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ ÙØ§Ø±Ø³ÛŒ Ù‡Ø³ØªÙ†Ø¯ Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§: Ø·ÙˆÙ„ØŒ Ø¹Ø±Ø¶ØŒ Ø§Ø±ØªÙØ§Ø¹</div>

                    <div class="formula-grid">
                        <div>
                            <label>Ú©ÛŒØ¨ÙˆØ±Ø¯ÛŒ â€” Ø¹Ø±Ø¶ Ø´ÛŒØª</label>
                            <textarea id="keyboardWidth" class="formula">3+Ø·ÙˆÙ„+(4Ã—Ø§Ø±ØªÙØ§Ø¹)</textarea>
                        </div>
                        <div>
                            <label>Ú©ÛŒØ¨ÙˆØ±Ø¯ÛŒ â€” Ø·ÙˆÙ„ Ø´ÛŒØª</label>
                            <textarea id="keyboardLength" class="formula">2+(2Ã—Ø¹Ø±Ø¶)+(3Ã—Ø§Ø±ØªÙØ§Ø¹)</textarea>
                        </div>

                        <div>
                            <label>Ú©Ø§Ø±ØªÙ† Ù…Ø§Ø¯Ø± â€” Ø¹Ø±Ø¶ Ø´ÛŒØª</label>
                            <textarea id="motherWidth" class="formula">Ø·ÙˆÙ„+Ø§Ø±ØªÙØ§Ø¹</textarea>
                        </div>
                        <div>
                            <label>Ú©Ø§Ø±ØªÙ† Ù…Ø§Ø¯Ø± â€” Ø·ÙˆÙ„ Ø´ÛŒØª</label>
                            <textarea id="motherLength" class="formula">4+2Ã—(Ø·ÙˆÙ„+Ø¹Ø±Ø¶)</textarea>
                        </div>

                        <div>
                            <label>ØªÙ‡ Ù‚ÙÙ„ÛŒ â€” Ø¹Ø±Ø¶ Ø´ÛŒØª</label>
                            <textarea id="lockBottomWidth" class="formula">5+0.5Ã—Ø¹Ø±Ø¶+Ø§Ø±ØªÙØ§Ø¹+Ø¹Ø±Ø¶</textarea>
                        </div>
                        <div>
                            <label>ØªÙ‡ Ù‚ÙÙ„ÛŒ â€” Ø·ÙˆÙ„ Ø´ÛŒØª</label>
                            <textarea id="lockBottomLength" class="formula">2Ã—(Ø·ÙˆÙ„+Ø¹Ø±Ø¶)+4</textarea>
                        </div>

                        <div>
                            <label>Ú©Ù„Ø§ÙÛŒ+Ù¾ÛŒØªØ²Ø§ÛŒÛŒ â€” Ø¹Ø±Ø¶ Ø´ÛŒØª</label>
                            <textarea id="coilPizzaWidth" class="formula">2+2Ã—Ø§Ø±ØªÙØ§Ø¹+Ø·ÙˆÙ„</textarea>
                        </div>
                        <div>
                            <label>Ú©Ù„Ø§ÙÛŒ+Ù¾ÛŒØªØ²Ø§ÛŒÛŒ â€” Ø·ÙˆÙ„ Ø´ÛŒØª</label>
                            <textarea id="coilPizzaLength" class="formula">4Ã—Ø§Ø±ØªÙØ§Ø¹+2Ã—Ø¹Ø±Ø¶</textarea>
                        </div>
                    </div>

                    <div style="display:flex;gap:8px;margin-top:12px;align-items:center;justify-content:space-between">
                        <div class="muted">Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ø¹Ù„Ø§Ù…Øª Ã— Ø¨Ø±Ø§ÛŒ Ø¶Ø±Ø¨ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯Ø› Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ Ù†ÛŒØ² Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
                        <div class="settings-actions">
                            <button id="resetSettingsBtn" class="btn" style="background:var(--danger);color:#fff">Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ</button>
                            <button id="saveSettingsBtn" class="btn" style="background:var(--success);color:#fff">Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <div id="toast" class="toast" role="status" aria-live="polite"></div>
    </div>

    <script>
        // ---------- Default formulas (same as original, preserved) ----------
        const defaultFormulas = {
            keyboard: { width: "3+Ø·ÙˆÙ„+(4Ã—Ø§Ø±ØªÙØ§Ø¹)", length: "2+(2Ã—Ø¹Ø±Ø¶)+(3Ã—Ø§Ø±ØªÙØ§Ø¹)" },
            mother: { width: "Ø·ÙˆÙ„+Ø§Ø±ØªÙØ§Ø¹", length: "4+2Ã—(Ø·ÙˆÙ„+Ø¹Ø±Ø¶)" },
            lockBottom: { width: "5+0.5Ã—Ø¹Ø±Ø¶+Ø§Ø±ØªÙØ§Ø¹+Ø¹Ø±Ø¶", length: "2Ã—(Ø·ÙˆÙ„+Ø¹Ø±Ø¶)+4" },
            coilPizza: { width: "2+2Ã—Ø§Ø±ØªÙØ§Ø¹+Ø·ÙˆÙ„", length: "4Ã—Ø§Ø±ØªÙØ§Ø¹+2Ã—Ø¹Ø±Ø¶" }
        };

        // load/save
        let formulas = JSON.parse(localStorage.getItem('cartonFormulas')) || defaultFormulas;

        function saveFormulasToStorage(){
            localStorage.setItem('cartonFormulas', JSON.stringify(formulas));
            showToast('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
        }

        function loadFormulasToInputs(){
            document.getElementById('keyboardWidth').value = formulas.keyboard.width;
            document.getElementById('keyboardLength').value = formulas.keyboard.length;
            document.getElementById('motherWidth').value = formulas.mother.width;
            document.getElementById('motherLength').value = formulas.mother.length;
            document.getElementById('lockBottomWidth').value = formulas.lockBottom.width;
            document.getElementById('lockBottomLength').value = formulas.lockBottom.length;
            document.getElementById('coilPizzaWidth').value = formulas.coilPizza.width;
            document.getElementById('coilPizzaLength').value = formulas.coilPizza.length;
        }

        // safety check (only after variables replaced) - allow digits, operators, parentheses and decimal point
        function isSafeMathExpression(expr){
            return /^[0-9+\-*/().\s]+$/.test(expr);
        }

        // evaluate formula with variable substitution and conversions
        function calculateFormula(formula, length, width, height){
            let expression = String(formula)
                .replace(/Ø·ÙˆÙ„/g, String(length))
                .replace(/Ø¹Ø±Ø¶/g, String(width))
                .replace(/Ø§Ø±ØªÙØ§Ø¹/g, String(height))
                .replace(/Ã—/g, '*')
                .replace(/Ã—/g, '*')
                .replace(/\u200C/g, '')
                .trim();

            // persian digits to latin
            expression = expression.replace(/[\u06F0-\u06F9]/g, function(d){return String(d.charCodeAt(0) - 0x06F0)});

            if(!isSafeMathExpression(expression)){
                console.error('ØºÛŒØ±Ù…Ø¬Ø§Ø²:', expression);
                return 'Ø®Ø·Ø§';
            }

            try{
                const result = Function('"use strict"; return (' + expression + ')')();
                if(typeof result === 'number' && isFinite(result)) return Number(result).toFixed(2);
                return 'Ø®Ø·Ø§';
            }catch(e){
                console.error('eval error', e, expression);
                return 'Ø®Ø·Ø§';
            }
        }

        // calculate all
        function calculateAll(){
            const L = parseFloat(document.getElementById('length').value) || 0;
            const W = parseFloat(document.getElementById('width').value) || 0;
            const H = parseFloat(document.getElementById('height').value) || 0;

            if(L <= 0 || W <= 0 || H <= 0){
                alert('Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø¹ØªØ¨Ø± Ø¨Ø±Ø§ÛŒ Ø·ÙˆÙ„ØŒ Ø¹Ø±Ø¶ Ùˆ Ø§Ø±ØªÙØ§Ø¹ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
                return;
            }

            const results = {
                keyboard: { width: calculateFormula(formulas.keyboard.width, L, W, H), length: calculateFormula(formulas.keyboard.length, L, W, H) },
                mother: { width: calculateFormula(formulas.mother.width, L, W, H), length: calculateFormula(formulas.mother.length, L, W, H) },
                lockBottom: { width: calculateFormula(formulas.lockBottom.width, L, W, H), length: calculateFormula(formulas.lockBottom.length, L, W, H) },
                coilPizza: { width: calculateFormula(formulas.coilPizza.width, L, W, H), length: calculateFormula(formulas.coilPizza.length, L, W, H) }
            };

            renderResults(results);
            renderQuickSummary(results);
        }

        function renderResults(res){
            const container = document.getElementById('resultsGrid');
            container.innerHTML = '';

            const map = [
                {key:'keyboard', title:'Ú©ÛŒØ¨ÙˆØ±Ø¯ÛŒ'},
                {key:'mother', title:'Ú©Ø§Ø±ØªÙ† Ù…Ø§Ø¯Ø±'},
                {key:'lockBottom', title:'ØªÙ‡ Ù‚ÙÙ„ÛŒ'},
                {key:'coilPizza', title:'Ú©Ù„Ø§ÙÛŒ + Ù¾ÛŒØªØ²Ø§ÛŒÛŒ'}
            ];

            map.forEach(m =>{
                const r = res[m.key];
                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `
                    <h3>${m.title}</h3>
                    <div class="dim"><div class="muted">Ø¹Ø±Ø¶ Ø´ÛŒØª</div><div class="v">${r.width} Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±</div></div>
                    <div class="dim"><div class="muted">Ø·ÙˆÙ„ Ø´ÛŒØª</div><div class="v">${r.length} Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±</div></div>
                    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                        <button class="copy-btn" data-val="${r.width} Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±" title="Ú©Ù¾ÛŒ">Ú©Ù¾ÛŒ Ø¹Ø±Ø¶</button>
                        <button class="copy-btn" data-val="${r.length} Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±" title="Ú©Ù¾ÛŒ">Ú©Ù¾ÛŒ Ø·ÙˆÙ„</button>
                    </div>
                `;
                container.appendChild(card);
            });

            // hook copy buttons
            container.querySelectorAll('.copy-btn').forEach(b=>b.addEventListener('click', e=>{
                const v = e.currentTarget.getAttribute('data-val');
                navigator.clipboard.writeText(v).then(()=>showToast('Ú©Ù¾ÛŒ Ø´Ø¯: '+v));
            }));
        }

        function renderQuickSummary(res){
            const el = document.getElementById('quickSummary');
            el.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div class="muted">Ú©ÛŒØ¨ÙˆØ±Ø¯ÛŒ â€” Ø¹Ø±Ø¶ Ã— Ø·ÙˆÙ„</div>
                    <div><strong>${res.keyboard.width} Ã— ${res.keyboard.length}</strong></div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                    <div class="muted">Ú©Ø§Ø±ØªÙ† Ù…Ø§Ø¯Ø±</div>
                    <div><strong>${res.mother.width} Ã— ${res.mother.length}</strong></div>
                </div>
            `;
        }

        // toast
        function showToast(msg){
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'),2500);
        }

        // ---------- settings drawer logic ----------
        const overlay = document.getElementById('overlay');
        const openSettingsBtn = document.getElementById('openSettings');
        const closeSettingsBtn = document.getElementById('closeSettings');

        function openSettings(){
            overlay.classList.add('show');
            overlay.setAttribute('aria-hidden','false');
            // load current formulas into inputs
            loadFormulasToInputs();
        }
        function closeSettings(){
            overlay.classList.remove('show');
            overlay.setAttribute('aria-hidden','true');
        }

        openSettingsBtn.addEventListener('click', openSettings);
        closeSettingsBtn.addEventListener('click', closeSettings);
        overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeSettings(); });

        // Save/Reset
        document.getElementById('saveSettingsBtn').addEventListener('click', ()=>{
            formulas = {
                keyboard: { width: document.getElementById('keyboardWidth').value, length: document.getElementById('keyboardLength').value },
                mother: { width: document.getElementById('motherWidth').value, length: document.getElementById('motherLength').value },
                lockBottom: { width: document.getElementById('lockBottomWidth').value, length: document.getElementById('lockBottomLength').value },
                coilPizza: { width: document.getElementById('coilPizzaWidth').value, length: document.getElementById('coilPizzaLength').value }
            };
            saveFormulasToStorage();
            closeSettings();
        });

        document.getElementById('resetSettingsBtn').addEventListener('click', ()=>{
            if(confirm('Ø¢ÛŒØ§ Ø§Ø² Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ Ø¨Ù‡ Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')){
                formulas = JSON.parse(JSON.stringify(defaultFormulas));
                saveFormulasToStorage();
                loadFormulasToInputs();
                showToast('ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯');
            }
        });

        // ---------- other UI hooks ----------
        document.getElementById('calcNow').addEventListener('click', calculateAll);
        document.getElementById('clearBtn').addEventListener('click', ()=>{
            document.getElementById('length').value='';document.getElementById('width').value='';document.getElementById('height').value='';
            document.getElementById('resultsGrid').innerHTML='';document.getElementById('quickSummary').innerHTML='<div class="muted">Ù†ØªØ§ÛŒØ¬ Ù¾Ø³ Ø§Ø² Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Â«Ù…Ø­Ø§Ø³Ø¨Ù‡Â» Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>';
        });

        document.getElementById('copyAll').addEventListener('click', ()=>{
            const nodes = document.querySelectorAll('#resultsGrid .result-card');
            const lines = [];
            nodes.forEach(n=>{
                const title = n.querySelector('h3').textContent.trim();
                const v1 = n.querySelectorAll('.v')[0].textContent.trim();
                const v2 = n.querySelectorAll('.v')[1].textContent.trim();
                lines.push(`${title}: Ø¹Ø±Ø¶ ${v1} â€” Ø·ÙˆÙ„ ${v2}`);
            });
            if(lines.length===0){ showToast('Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯'); return }
            navigator.clipboard.writeText(lines.join('\n')).then(()=>showToast('ØªÙ…Ø§Ù… Ù†ØªØ§ÛŒØ¬ Ú©Ù¾ÛŒ Ø´Ø¯'));
        });

        document.getElementById('exportCsv').addEventListener('click', ()=>{
            const nodes = document.querySelectorAll('#resultsGrid .result-card');
            if(nodes.length===0){ showToast('Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯'); return }
            const rows = ['Ù†ÙˆØ¹,Ø¹Ø±Ø¶,Ø·ÙˆÙ„'];
            nodes.forEach(n=>{
                const title = n.querySelector('h3').textContent.trim();
                const v1 = n.querySelectorAll('.v')[0].textContent.replace(' Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±','').trim();
                const v2 = n.querySelectorAll('.v')[1].textContent.replace(' Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±','').trim();
                rows.push(`${title},${v1},${v2}`);
            });
            const csv = rows.join('\n');
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download='carton-results.csv'; a.click(); URL.revokeObjectURL(url);
        });

        // keyboard shortcut (G) opens settings
        window.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='g') openSettings(); });

        // ---------- PWA install logic (kept and improved) ----------
        let deferredPrompt = null;
        const installButton = document.getElementById('installButton');
        if(installButton) installButton.style.display = 'none';

        window.addEventListener('beforeinstallprompt', (e)=>{
            e.preventDefault(); deferredPrompt = e; if(installButton){ installButton.style.display='inline-flex'; }
        });
        if(installButton){ installButton.addEventListener('click', async ()=>{
            if(!deferredPrompt) return; deferredPrompt.prompt(); try{ const choice = await deferredPrompt.userChoice; if(choice.outcome==='accepted') installButton.style.display='none'; }catch(e){console.error(e);} finally{deferredPrompt=null}
        }); }

        window.addEventListener('appinstalled', ()=>{ if(installButton) installButton.style.display='none'; deferredPrompt=null; showToast('Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ØµØ¨ Ø´Ø¯'); });
        function hideInstallIfStandalone(){ try{ if(window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone===true) installButton.style.display='none' }catch(e){} }
        hideInstallIfStandalone();

        // register service worker (relative)
        if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('sw.js').then(r=>console.log('SW scope:', r.scope)).catch(err=>console.warn('SW failed', err)); }); }

        // init
        loadFormulasToInputs();
    </script>
</body>
</html>
